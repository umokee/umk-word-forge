# Спецификация тренировки слов (v3)

## Принципы дизайна для ISTJ + Enneagram 6

### Что важно:
1. **Предсказуемость** — пользователь всегда знает что будет дальше
2. **Структура** — чёткий порядок, никакого хаоса
3. **Надёжность** — никаких багов, всё работает как заявлено
4. **Прозрачность** — видно как работает система, почему выбраны эти слова
5. **Честность** — прямая обратная связь, но без лишней жёсткости
6. **Эффективность** — не тратить время на лишнее, уважать время пользователя
7. **Контроль** — пользователь контролирует процесс, не приложение его

### Чего избегать:
- Геймификация (стрики, достижения, звуки победы)
- Случайность без объяснения
- Анимации ради анимаций
- Социальные элементы
- "Весёлые" сообщения

---

## Структура тренировочной сессии

### Порядок упражнений (КРИТИЧНО)

**Неправильно (как сейчас):**
```
Слово1: Intro → Recognition → Recall → Context
Слово2: Intro → Recognition → Recall → Context
Слово3: Intro → Recognition → Recall → Context
```
Проблема: кажется что это 40 слов, а не 10 слов по 4 упражнения.

**Правильно (как должно быть):**
```
ФАЗА 1: Все Introduction (10 слов)
  - Слово1: Intro
  - Слово2: Intro
  - Слово3: Intro
  ...

ФАЗА 2: Все Recognition (10 слов)
  - Слово1: Recognition
  - Слово2: Recognition
  ...

ФАЗА 3: Все Recall (10 слов)
  - Слово1: Recall
  ...

ФАЗА 4: Все Context (10 слов)
  - Слово1: Context
  ...
```

### Полоска прогресса

**Неправильно:** одна полоска на 40 упражнений
**Правильно:**
- Показывать текущую фазу: "Фаза 1/4: Знакомство"
- Прогресс внутри фазы: "3/10 слов"
- Общий прогресс сессии: "10/40 упражнений"

```
┌─────────────────────────────────────────────────────────┐
│  Фаза 1: Знакомство                           3/10     │
│  ████████░░░░░░░░░░░░░░░░░░░░░                          │
│                                                         │
│  Общий прогресс: 3/40                                   │
└─────────────────────────────────────────────────────────┘
```

---

## Типы упражнений (подробно)

### Фаза 1: Introduction (Знакомство)

**Цель:** Первое знакомство со словом. Пользователь видит слово, запоминает.

**Что показывать:**
1. Слово (крупно)
2. Транскрипция
3. Часть речи
4. Перевод(ы)
5. **ОБЯЗАТЕЛЬНО: 1-2 примера использования** (sentence_en + sentence_ru)
6. Формы глагола (если глагол)
7. Коллокации (если есть, 2-3 штуки)
8. Кнопка озвучивания

**Для служебных слов (the, a, to, in):**
- Вместо перевода: "(служебное слово, нет прямого перевода)"
- Правила использования (3-4 пункта с примерами)
- Сравнение с похожими словами (the vs a)
- Типичные ошибки русскоговорящих

**Действие пользователя:** Нажать "Понял" или клавишу Enter/Space

**Что записывается в БД:** НИЧЕГО! Слово ещё не изучено. UserWord создаётся только после успешного прохождения ВСЕХ 4 фаз для этого слова в сессии.

### Фаза 2: Recognition (Узнавание)

**Цель:** Узнать перевод слова из вариантов.

**Формат:**
```
Выберите перевод:

    make

    /meɪk/

    ○ делать
    ○ брать
    ○ идти
    ○ давать

    [1] [2] [3] [4]  — горячие клавиши
```

**Варианты ответов:**
- 1 правильный
- 3 дистрактора (того же part_of_speech)

**Обратная связь:**
- Правильно: зелёная галочка, переход к следующему (авто через 0.5 сек)
- Неправильно: красный X, показать правильный ответ, кнопка "Далее"

**30% обратных упражнений:**
- Показать перевод → выбрать английское слово
- Помечается как `reverse: true`

### Фаза 3: Recall (Вспоминание)

**Цель:** Вспомнить перевод без подсказок.

**Формат:**
```
Напишите перевод:

    make

    /meɪk/

    [________________] [Проверить]
```

**Проверка ответа:**
- Точное совпадение (с нормализацией: lowercase, trim)
- Levenshtein distance ≤ 1 при длине слова > 3 = опечатка, засчитывается как правильно
- Принимается любой из переводов из массива translations

**Обратная связь:**
- Правильно: "Верно!" (зелёный)
- Опечатка: "Верно! (небольшая опечатка)" (жёлтый)
- Неправильно: "Правильный ответ: делать" (нейтральный тон)

### Фаза 4: Context (Контекст)

**Цель:** Понять слово в контексте предложения.

**Формат:**
```
Выберите перевод слова в контексте:

    "I need to make a decision by tomorrow."
    "Мне нужно принять решение до завтра."

    make

    ○ делать
    ○ принимать (решение)
    ○ создавать
    ○ заставлять
```

**Важно:**
- Примеры должны быть качественные (не "This is a make")
- Показывать и английское и русское предложение
- Варианты должны быть контекстно релевантны

---

## Запись прогресса (КРИТИЧНО)

### Когда создавать UserWord:
- **НЕ** после Introduction
- **НЕ** после каждого упражнения
- **ТОЛЬКО** после завершения всех 4 фаз для слова в сессии

### Алгоритм:
```python
# В конце сессии, для каждого нового слова:
if all_4_phases_completed(word_id):
    # Считаем результаты
    correct_count = count_correct(word_id)  # 0-4

    if correct_count >= 3:
        # Слово изучено, создаём UserWord
        create_user_word(word_id, mastery_level=2)  # Начинаем с уровня 2
    else:
        # Слишком много ошибок, слово появится снова как новое
        pass  # Не создаём UserWord
```

### Уровни мастерства:
- Level 1: Introduction (но мы пропускаем это, начинаем с 2)
- Level 2: Recognition — повторяем пока не будет 3 правильных подряд
- Level 3: Recall — повторяем пока не будет 3 правильных подряд
- Level 4: Context — повторяем пока не будет 3 правильных подряд
- Level 5: Sentence Builder
- Level 6: Free Production
- Level 7: Listening/Mastered

### FSRS интеграция:
- FSRS определяет КОГДА повторять (next_review_at)
- mastery_level определяет КАКОЕ упражнение показывать
- Это независимые системы

---

## Слова для повторения vs Новые слова

### Структура сессии:
```
1. Слова на повторение (overdue + learning)
   - Каждое слово = 1 упражнение (по его mastery_level)
   - Сначала все упражнения уровня 2, потом 3, потом 4...

2. Новые слова
   - 4 фазы как описано выше
   - Группировка по фазам
```

### Пример сессии (10 слов повторение + 5 новых):
```
--- ПОВТОРЕНИЕ ---
Фаза Recognition (уровень 2): word1, word2, word3
Фаза Recall (уровень 3): word4, word5
Фаза Context (уровень 4): word6, word7, word8
Фаза Sentence Builder (уровень 5): word9, word10

--- НОВЫЕ СЛОВА ---
Фаза Introduction: new1, new2, new3, new4, new5
Фаза Recognition: new1, new2, new3, new4, new5
Фаза Recall: new1, new2, new3, new4, new5
Фаза Context: new1, new2, new3, new4, new5
```

---

## UI/UX детали

### Прогресс бар:
```
┌─────────────────────────────────────────────────────────┐
│ Повторение: Recognition                        3/3 ✓   │
│ Повторение: Recall                             2/2 ✓   │
│ Повторение: Context                            1/3     │
│ ████████████████░░░░░░░░                               │
│                                                         │
│ Новые слова: ожидают                                   │
└─────────────────────────────────────────────────────────┘
```

### Цветовая схема обратной связи:
- Правильно: #00ff88 (зелёный)
- Опечатка: #f59e0b (жёлтый/оранжевый)
- Неправильно: НЕ красный! Используем нейтральный серый с текстом
  - Причина: высокий нейротизм, красный вызывает стресс
  - Вместо: светло-серый фон, спокойный текст "Правильный ответ: ..."

### Кнопки:
- Всегда показывать состояние (loading, disabled)
- Горячие клавиши везде (1,2,3,4 для выбора, Enter для подтверждения, Esc для выхода)
- Не блокировать UI на время запроса — показывать что происходит

### Звуки:
- По умолчанию ВЫКЛЮЧЕНЫ
- Только TTS для слов (по запросу)
- Никаких звуков "победы" или "ошибки"

---

## Настройки пользователя (релевантные)

```
daily_new_words: 10          # Сколько новых слов в день
max_reviews_per_session: 50  # Максимум слов на повторение
session_duration_minutes: 15 # Игнорируем, ориентируемся на количество
new_words_position: "end"    # Новые слова в конце сессии
show_transcription: true     # Показывать транскрипцию
show_example_translation: true # Показывать перевод примеров
```

---

## API изменения

### POST /api/training/session response:
```json
{
  "session_id": 123,
  "phases": [
    {
      "type": "review",
      "exercise_type": 2,
      "name": "Recognition",
      "exercises": [...],
      "count": 3
    },
    {
      "type": "review",
      "exercise_type": 3,
      "name": "Recall",
      "exercises": [...],
      "count": 2
    },
    {
      "type": "new_words",
      "phase": 1,
      "name": "Знакомство",
      "exercises": [...],
      "count": 5
    },
    {
      "type": "new_words",
      "phase": 2,
      "name": "Recognition",
      "exercises": [...],
      "count": 5
    }
    // ...
  ],
  "total_exercises": 35,
  "review_words_count": 10,
  "new_words_count": 5
}
```

### Exercise object:
```json
{
  "word_id": 123,
  "exercise_type": 1,
  "english": "make",
  "transcription": "/meɪk/",
  "translations": ["делать", "создавать"],
  "part_of_speech": "verb",

  // ОБЯЗАТЕЛЬНО для Introduction:
  "contexts": [
    {
      "sentence_en": "I need to make a decision.",
      "sentence_ru": "Мне нужно принять решение."
    }
  ],

  // Для Recognition/Context:
  "options": ["делать", "брать", "идти", "давать"],

  // Для Context:
  "context_sentence_en": "...",
  "context_sentence_ru": "...",

  // Для служебных слов:
  "is_function_word": true,
  "usage_rules": [...],
  "comparisons": [...],
  "common_errors": [...]
}
```

---

## Обработка ошибок

### При ошибке сети:
- Показать сообщение: "Ошибка связи. Ваш ответ сохранён локально."
- Сохранить ответ в localStorage
- Повторить отправку при восстановлении связи
- НЕ терять прогресс пользователя

### При ошибке сервера:
- Показать конкретную ошибку (не "Internal Server Error")
- Предложить действие: "Попробовать снова" или "Пропустить"
- Логировать для отладки

---

## Что НЕ делать

1. ❌ Не показывать "Отлично!" "Супер!" "Молодец!" — это раздражает
2. ❌ Не использовать эмодзи в интерфейсе
3. ❌ Не добавлять случайные элементы ("случайный факт о слове!")
4. ❌ Не менять порядок упражнений случайно
5. ❌ Не скрывать информацию о системе
6. ❌ Не делать анимации дольше 200ms
7. ❌ Не блокировать интерфейс без объяснения
8. ❌ Не терять данные пользователя никогда

---

## Метрики успеха

После внедрения этих изменений:
1. Пользователь понимает где он в сессии
2. Пользователь видит примеры для каждого слова
3. Слова записываются только после полного прохождения
4. Кнопки работают всегда
5. Ошибки показываются понятно
6. Миграции применяются без ручного вмешательства

---

## Порядок реализации

1. **Фаза 1: Исправить критические баги**
   - Кнопки работают
   - Ошибки в Recognition
   - Миграции

2. **Фаза 2: Изменить структуру сессии**
   - Группировка по фазам
   - Новый прогресс бар
   - Изменить API response

3. **Фаза 3: Улучшить Introduction**
   - Добавить примеры (обязательно)
   - Служебные слова
   - Не записывать UserWord сразу

4. **Фаза 4: Правильная запись прогресса**
   - UserWord создаётся после 4 фаз
   - Правильный mastery_level

5. **Фаза 5: Полировка**
   - Убрать лишние сообщения
   - Цвета обратной связи
   - Горячие клавиши везде
